---
layout: post
title: "linux commands tips: iptables"
description: ""
category: 网络安全
subtitle:
author: "fishcried"
header-img: "img/bg/home-bg.jpg"
tags: [网络安全,防火墙,iptables,netfilter]
---

# Iptables & Netifilter哪个才是防火墙?


![netfilter与iptables的关系](/img/netfilter_iptables.png)

上面这张图说明的是iptables与netfilter的关系.有人管linux防火墙叫iptables,有人叫netfilter/iptables,有人叫netfilter.其实无所谓,只是角度不同而已.

- Netfilter是一套数据包过滤框架,在处理ip数据包时hook了5个关键钩子.通过这5个关键点来实现各种功能,比如firewall/ips.
- Iptables就是真正的内核防火墙模块,通过把自己的函数注入到Netfilter的框架中来实现的防火墙功能.
- Netfilter提供了最基本的底层支撑,具体的功能实现只要注册自己的函数就可以了.这样保证了协议栈的纯净与可扩展性.通过上图可以看出netfilter与iptables是分离的.

所以linux防火墙的不同叫法只是角度的问题: iptables(防火墙的功能代码确实都是在iptables模块中实现), netfilter/iptables(iptables依赖的netfilter), netfilter(核心还是netfilter框架,这种是有点装x的叫法).

**Netfilter的Hook点**

![netfilter包处理](/img/netfilter_arch.png)

数据包从左边进入IP协议栈，进行IP校验以后，数据包被第一个钩子函数PRE\_ROUTING处理，然后就进入路由模块，由其决定该数据包是转发出去还是送给本机。若该数据包是送给本机的，则要经过钩子函数LOCAL_IN处理后传递给本机的上层协议；若该数据包应该被转发，则它将被钩子函数FORWARD处理，然后还要经钩子函数POST_ROUTING处理后才能传输到网络。本机进程产生的数据包要先经过钩子函数LOCAL_OUT处理后，再进行路由选择处理，然后经过钩子函数POST_ROUTING处理后再发送到网络。

`**内核模块可以将自己的函数注册到钩子函数中，每当有数据包经过该钩子点时，钩子函数就会按照优先级依次调用这些注册的函数，从而可以使其他内核模块参与对数据包的处理。这些处理可以是包过滤、NAT以及用户自定义的一些功能.**`


如果google iptables,会看到很多关于nftables的资料.简单来说nftables是为了替换iptables,同样是基于netfilter.之所以要进行替换是因为iptables配置起来太复杂.但是这种替换真的是太难了.

# Iptables的机理

已经知道iptables是基于netfilter,实际就是在不同的hook点按照优先级插入自己的功能函数.Iptables以表->链->规则的形式来组织.如下图

![iptables的表与链](/img/iptables01.png)

iptables有四个表raw,mangle,filter,nat.其实是四种大的功能.每个表中又存在不同的链,这些链的名字与netfilter的hook点名字相同,实际上这些链的功能函数就是插入到相应的hook位置了.每个表的链都是独立的.然后链内的包含具体规则,也就是具体的acl.

**Filter机制**

filter表用于实现filter机制,其实就是防火墙功能.filter表中的三个链INPUT,FORWARD,OUTPUT分别处理对应类型的数据包.通过在对应的链上设置规则最终对数据包进行控制.通俗的讲,INPUT用户保护本机,OUTPUT用户限制本机应用程序的网络访问,FORWARD一般用户保护后端的服务器.

- INPUT 进入本机进程的数据包
- FORWARD 主机扮演的是路由的角色,经由本机的数据包
- OUTPUT 本机进程生成数据包

**NAT机制**

NAT(Network Address Traslation),网络地址转换.包含了PREROUTING -> OUTPUT-> POSTROUTING,链.

- PREROUTING  在路由之前先修改目的ip,实现DNAT
- OUTPUT  用于解决本机发送的数据包实现DNAT功能.因为本机发送的数据包会经由OUTPUT-> POSTROUTING, POSTROUTING只能做SNAT,所以设计了OUTPUT来处理本机发送数据的DNAT.
- POSTROUTING 数据包离开时经由POSTROUTING,用户修改源地址,实现SNAT.

**Mangle机制**

用来修改数据包.

**Raw机制**

用来进行连接跟踪设置.可以加速规则匹配.

整体来看iptables的数据处理流程就是下图:

![iptables的数据包处理流程](/img/iptables02.png)


# iptables的使用

如果非必要,真没有人愿意去详细的学习iptables语法,写起来太麻烦.其实熟悉熟悉,发现也不是很难掌握.

iptables使用的语法: `iptables [-t table] 操作 chain RULE `,下面是总结的思维导图:

![iptables的使用](/img/iptables_usage.png)

**iptables & iptables-save?**

很多时候`iptables-save`使用比iptables还多,这个命令主要是把内存态的规则保存到文件,然后下次启动的时候用`iptables-restore`来载入规则.但是这个命令也可以用于查看防火墙规则.输出结果的格式.其输出比较紧凑直观.而且一下子能够看到多有表.

    ┌─[ubuntu@fishcried] - [~] - [2015-07-17 05:47:22]
    └─[0] sudo iptables-save
    # Generated by iptables-save v1.4.21 on Fri Jul 17 17:46:45 2015
    *mangle
    :PREROUTING ACCEPT [170491:25205613]
    :INPUT ACCEPT [170491:25205613]
    :FORWARD ACCEPT [0:0]
    :OUTPUT ACCEPT [186436:72064133]
    :POSTROUTING ACCEPT [186436:72064133]
    COMMIT
    # Completed on Fri Jul 17 17:46:45 2015
    # Generated by iptables-save v1.4.21 on Fri Jul 17 17:46:45 2015
    *nat
    :PREROUTING ACCEPT [726722:43601168]
    :INPUT ACCEPT [726722:43601168]
    :OUTPUT ACCEPT [17016:1033385]
    :POSTROUTING ACCEPT [17016:1033385]
    :DOCKER - [0:0]
    -A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER
    -A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER
    -A POSTROUTING -s 172.17.0.0/16 ! -d 172.17.0.0/16 -j MASQUERADE
    COMMIT
    # Completed on Fri Jul 17 17:46:45 2015
    # Generated by iptables-save v1.4.21 on Fri Jul 17 17:46:45 2015
    *filter
    :INPUT ACCEPT [5130295:773100722]
    :FORWARD ACCEPT [0:0]
    :OUTPUT ACCEPT [5052679:681817970]
    -A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
    -A FORWARD -i docker0 ! -o docker0 -j ACCEPT
    -A FORWARD -i docker0 -o docker0 -j ACCEPT
    COMMIT
    # Completed on Fri Jul 17 17:46:45 2015


- 输出是分段的,每个段落一个表,*开头后面跟着表名
- :开头的行是对链匹配次数的总结,后面跟着统计信息,[数据包:字节数].
- 后面跟着的是具体规则
- 最后跟着`COMMIT`表示一个表的结束

`iptables-save`有两个选项:
- -t 后面可以指定表明
- -c 输出会在每条规则前加上匹配信息

**如何快速查看iptables的流量匹配?**

    iptables [-t 表] -L [链] -nv
    iptables-save -c

如果想快速的查看规则匹配情况,可以使用上面两条命令.第一条命令较为灵活,可以控制表和链,而且统计信息比较人性化.第二条命令简单.

**iptables自定义连**

如果想自行定义规则链,可以通过`-N`参数,然后通过`-j/--jump`跳转过来就可以了.

    iptables -N 链名
    iptables ... -j 链名

# iptables规则调优策略

**优化的核心原则就是减少规则匹配.**

- 简化规则
	- 用`multiport`,`iprange`模块,简化规则数量,也减少了匹配次数.
- 调整匹配顺序
	- 书写规则顺序的原则,通用匹配放在前面. 配合`iptable -t tname -Lnv`的观察数据
	- 提前规则的在表的位置.例如将filter表中针对dnat后匹配的规则放到raw中匹配,需要使用没有做dnat的ip.这样减少了很多次匹配.
	- 分层优化,减少匹配顺序.通过自定义的链,来跳转规则.这样就能减少匹配次数了

# 实用场景

**tcp通用规则**

	# 这条规则能够过滤掉很多类型的端口扫描
	iptables -t filter -A INPUT -p tcp  -m state --state INVALID -j DROP
	# 避免配置很多内部端口通行规则
	iptables -t filter -A INPUT -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPT

**端口扫描**
state与recent模块配合使用.30分钟内发起22,21,80以外端口超过10次,认为是portscan.

	iptables -A INPUT -p all -m state --state ESTABLISHED,RELATED -j ACCEPT
	iptables -A INPUT -p all -m state --state NEW -m recent --name port_scan --update --seconds 1800 --hitcount 10 -j DROP
	iptables -A INPUT -p tcp --syn -m state --state NEW -m multiport --dports 22,21,80 -j ACCEPT
	iptables -A INPUT -p all -m recent --name port_scan --set

**暴力猜解**
暴力猜解会发起很多次尝试,主要是在这里下手.

    #pop3猜解
    iptables -A OUTPUT -p tcp --sport 110 -m string --algo bm --string "-ERR Authentication failed." \
                              -m recent --name pop3 \
                              --update --seconds 600 --hicount 6 -j REJECT
    iptables -A OUTPUT -p tcp --sport 110 -m string --algo bm --string "-ERR Authentication failed." \
                              -m recent --name pop3 --set

    #ssh猜解
	  iptables -A INPUT -p tcp --syn --dport 22 -m recent --name ssh --update --seconds 600 --hitcount 4 -j DROP
	  iptables -A INPUT -p tcp --syn --dport 22 -m recent --name ssh --set

**Syn flood**

	modprobe ipt_recent ip_list_tot=16384
	iptables -N SYN_FLOOD
	iptables -A FORWARD -p tcp --syn --dport 80 -m limit --limit 1/m --limit-burst 300 -j ACCEPT
	iptables -A FORWARD -p tcp --syn --dport 80 -j SYN_FLOOD
	iptables -A SYN_FLOOD -p tcp --syn --dport 80 -m recent --name syn_flood --update --second 123 --hitcount 1 -j ACCEPT
	iptables -A SYN_FLOOD -p tcp --syn --dport 80 -m recent --name syn_flood --set
	iptables -A SYN_FLOOD -p tcp --syn --dport 80 -j DROP

也可以通过调整网络子系统的参数来抵御flood攻击:

- net.ipv4.tcp_synack_retries
- net.ipv4.tcp_max_syn_backlog
- net.ipv4.tcp_syncookies

**ip欺骗经典配置**

- 任何进入网络的数据包不能把网络内部的地址作为源地址。
- 任何进入网络的数据包必须把网络内部的地址作为目的地址。
- 任何离开网络的数据包必须把网络内部的地址作为源地址。
- 任何离开网络的数据包不能把网络内部的地址作为目的地址。
- 任何进入或离开网络的数据包不能把一个私有地址(Private Address)或在RFC1918中列出的属于保留空间(包括10.x.x.x/8、172.16.x.x/12 或192.168.x.x/16 和网络回送地址127.0.0.0/8.)的地址作为源或目的地址。
- 阻塞任意源路由包或任何设置了IP选项的包。

# 变更记录

|Why | Who | When |
|----|-----|------|
|create|fishcired|2014-08-28 |
|完善思维导图,添加实例|fishcired|2014-08-29	|
|调整内容,完善思维导图|fishcired|2015-07-17 |
